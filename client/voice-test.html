<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Test - Direct Access</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .control-panel { background: #333; padding: 20px; border-radius: 10px; margin: 10px 0; }
        button { background: #0066cc; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0088ff; }
        button:disabled { background: #666; cursor: not-allowed; }
        select { background: #444; color: white; border: 1px solid #666; padding: 5px; margin: 5px; }
        .status { background: #444; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #006600; }
        .error { background: #660000; }
    </style>
</head>
<body>
    <h1>Voice Features Test Page</h1>
    <p>Direct access to voice functionality without cache interference</p>
    
    <div class="control-panel">
        <h3>Voice System Test</h3>
        <button onclick="testVoiceGeneration()">Test Voice Generation</button>
        <button onclick="replayLastAudio()" id="replayBtn" disabled>Replay Last Audio</button>
        <div id="status" class="status">Ready to test voice features</div>
    </div>

    <div class="control-panel">
        <h3>Voice Selection</h3>
        <select id="voiceSelect">
            <option value="iCrDUkL56s3C8sCRl7wb">Hope (Female)</option>
            <option value="FA6HhUjVmxBGQLlzA8WZ">Ophelia (Female)</option>
            <option value="pFZP5JQG7iQjIQuC4Bku">Brian (Male)</option>
            <option value="ErXwobaYiN019PkySvjV">Antoni (Male)</option>
            <option value="VR6AewLTigWG4xSOukaG">Arnold (Male)</option>
        </select>
        <button onclick="setVoice()">Set Voice</button>
        <button onclick="testSelectedVoice()">Test Selected Voice</button>
    </div>

    <div class="control-panel">
        <h3>Reflection Reading</h3>
        <button onclick="readReflection()">Read Weekly Reflection</button>
        <div id="reflectionText" style="max-height: 200px; overflow-y: auto; background: #222; padding: 10px; margin: 10px 0;"></div>
    </div>

    <script>
        let lastAudioUrl = null;
        
        async function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            console.log(message);
        }

        async function testVoiceGeneration() {
            updateStatus('Testing voice generation...');
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'Voice system test successful. All features are working properly.' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                lastAudioUrl = audioUrl;

                const audio = new Audio(audioUrl);
                audio.volume = 1.0;
                
                audio.play().then(() => {
                    updateStatus('Voice generation successful - audio playing', 'success');
                    document.getElementById('replayBtn').disabled = false;
                }).catch(error => {
                    updateStatus('Audio blocked by browser - click replay to enable', 'error');
                    document.getElementById('replayBtn').disabled = false;
                });
                
            } catch (error) {
                updateStatus(`Voice generation failed: ${error.message}`, 'error');
            }
        }

        async function replayLastAudio() {
            if (!lastAudioUrl) {
                updateStatus('No audio to replay', 'error');
                return;
            }

            try {
                const audio = new Audio(lastAudioUrl);
                audio.volume = 1.0;
                await audio.play();
                updateStatus('Audio replay successful', 'success');
            } catch (error) {
                updateStatus(`Replay failed: ${error.message}`, 'error');
            }
        }

        async function setVoice() {
            const voiceId = document.getElementById('voiceSelect').value;
            try {
                const response = await fetch('/api/voice/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voiceId })
                });

                if (response.ok) {
                    updateStatus(`Voice set to ${voiceId}`, 'success');
                } else {
                    throw new Error(`Failed to set voice: ${response.status}`);
                }
            } catch (error) {
                updateStatus(`Voice setting failed: ${error.message}`, 'error');
            }
        }

        async function testSelectedVoice() {
            const voiceId = document.getElementById('voiceSelect').value;
            const voiceName = document.getElementById('voiceSelect').selectedOptions[0].text;
            
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: `Hello, this is ${voiceName}. Voice selection is working correctly.`,
                        voiceId: voiceId
                    })
                });

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                lastAudioUrl = audioUrl;

                const audio = new Audio(audioUrl);
                audio.volume = 1.0;
                await audio.play();
                
                updateStatus(`${voiceName} voice test successful`, 'success');
                document.getElementById('replayBtn').disabled = false;
            } catch (error) {
                updateStatus(`Voice test failed: ${error.message}`, 'error');
            }
        }

        async function readReflection() {
            try {
                // Get weekly reflection
                const reflectionResponse = await fetch('/api/weekly-summary?userId=1');
                const reflectionData = await reflectionResponse.json();
                
                document.getElementById('reflectionText').textContent = reflectionData.summary;
                
                // Read it aloud
                const voiceId = document.getElementById('voiceSelect').value;
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: reflectionData.summary,
                        voiceId: voiceId
                    })
                });

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                lastAudioUrl = audioUrl;

                const audio = new Audio(audioUrl);
                audio.volume = 1.0;
                await audio.play();
                
                updateStatus('Reading reflection aloud', 'success');
                document.getElementById('replayBtn').disabled = false;
            } catch (error) {
                updateStatus(`Reflection reading failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        updateStatus('Voice test page loaded - ready to test features');
    </script>
</body>
</html>